<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spelling AB</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* 依據截圖取色 */
            --bg-body: #161a23;       /* 整體背景深色 */
            --card-bg: #1f2430;       /* 中間卡片背景 */
            --slot-empty: #2d3442;    /* 空格/未選鍵盤顏色 */
            
            /* 狀態色 (填充用) */
            --blue: #3b82f6;          /* 正確 */
            --yellow: #eab308;        /* 位置錯 */
            --red: #ef4444;           /* 錯誤 (鍵盤用) */
            --red-bg: #dc2626;        /* 錯誤 (格子用) */
            --btn-red: #c53c33;       /* Begin 按鈕 */
            
            --text-white: #ffffff;
            --text-gray: #94a3b8;
            --text-highlight: #60a5fa; /* Hint 亮色 */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            color: var(--text-white);
            font-family: 'Roboto', sans-serif;
            height: 100vh; /* 滿版 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* 防止滾動 */
        }

        /* --- 主容器 (卡片風格) --- */
        .game-container {
            background-color: var(--card-bg);
            width: 90%;
            max-width: 400px;
            border-radius: 16px;
            padding: 24px 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        /* --- 標題 --- */
        h1 {
            font-family: 'Orbitron', sans-serif;
            margin: 0 0 20px 0;
            font-size: 1.8rem;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }

        /* --- 答案框框區 --- */
        #answer-board {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            justify-content: center;
            flex-wrap: wrap;
            min-height: 60px; /* 預留高度 */
        }

        .slot {
            width: 45px;
            height: 55px;
            background-color: var(--slot-empty);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 26px;
            font-weight: 700;
            color: var(--text-white); /* 字體永遠白色 */
            border: 2px solid transparent;
            transition: all 0.2s ease;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* 狀態樣式 (背景變色) */
        .slot.blue { background-color: var(--blue); border-color: var(--blue); }
        .slot.yellow { background-color: var(--yellow); border-color: var(--yellow); }
        .slot.red { background-color: var(--btn-red); opacity: 0.8; } /* 錯誤紅 */

        /* 特殊：白色虛線 (多重出現) */
        .slot.multi-occur {
            border: 2px dashed rgba(255, 255, 255, 0.9) !important;
        }

        /* --- Hint 區域 --- */
        .hint-area {
            font-size: 0.85rem;
            color: var(--text-gray);
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.4;
        }
        .hint-val { color: var(--text-highlight); font-weight: bold; }

        /* --- 鍵盤顯示板 (QWERTY) --- */
        #keyboard-display {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 25px;
            width: 100%;
        }
        
        .kb-row { display: flex; justify-content: center; gap: 4px; }
        
        .kb-key {
            width: 28px;
            height: 38px;
            background-color: var(--slot-empty); /* 預設灰 */
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            color: #ccc;
            transition: background-color 0.2s;
        }

        /* 鍵盤顏色狀態 */
        .kb-key.active-blue { background-color: var(--blue); color: white; }
        .kb-key.active-yellow { background-color: var(--yellow); color: #1a1e29; } /* 黃底黑字比較清楚 */
        .kb-key.active-red { background-color: var(--btn-red); opacity: 0.4; }

        /* --- 控制區 (Level & Button) --- */
        .control-label {
            font-size: 0.9rem;
            color: var(--text-white);
            margin-bottom: 10px;
        }

        .level-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            width: 100%;
            margin-bottom: 20px;
        }

        .lvl-btn {
            background-color: transparent;
            border: 1px solid #475569;
            color: #94a3b8;
            padding: 10px 0;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .lvl-btn.selected {
            background-color: var(--blue);
            color: white;
            border-color: var(--blue);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
        }

        #begin-btn {
            width: 100%;
            background-color: var(--btn-red);
            color: white;
            border: none;
            padding: 14px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(197, 60, 51, 0.4);
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1px;
        }
        
        #begin-btn:active { transform: scale(0.98); }

        /* --- Footer --- */
        footer {
            margin-top: 20px;
            text-align: center;
            color: #475569;
            font-size: 0.65rem;
            line-height: 1.4;
            max-width: 90%;
        }

        /* --- 隱藏輸入框 (核心魔法) --- */
        #hidden-input {
            position: absolute;
            opacity: 0;
            top: -9999px;
            left: -9999px;
        }
    </style>
</head>
<body>

    <div class="game-container">
        <h1>Spelling AB</h1>

        <div id="answer-board">
            <div class="slot" style="background: transparent; border: 2px solid #333; color: #555;">?</div>
            <div class="slot" style="background: transparent; border: 2px solid #333; color: #555;">?</div>
            <div class="slot" style="background: transparent; border: 2px solid #333; color: #555;">?</div>
        </div>

        <div class="hint-area" id="hint-display">
            Hint | Select a level and begin!
        </div>

        <div id="keyboard-display"></div>

        <div class="control-label">Select your challenge.</div>
        
        <div class="level-container">
            <button class="lvl-btn selected" onclick="selectLevel(1)">Lv. 1</button>
            <button class="lvl-btn" onclick="selectLevel(2)">Lv. 2</button>
            <button class="lvl-btn" onclick="selectLevel(3)">Lv. 3</button>
            <button class="lvl-btn" onclick="selectLevel(4)">Lv. 4</button>
            <button class="lvl-btn" onclick="selectLevel(5)">Lv. 5</button>
            <button class="lvl-btn" onclick="selectLevel(6)">Lv. 6</button>
        </div>

        <button id="begin-btn" onclick="startGame()">Begin</button>
    </div>

    <footer>
        &copy; 2025 Spelling AB · Source: CEEC · Translations via Google Translate<br>
        Independent project by Simonpaul / Lai-BoHao · All rights reserved
    </footer>

    <input type="text" id="hidden-input" autocomplete="off" autocorrect="off" spellcheck="false">

    <script>
        // --- 全域變數 ---
        let vocabList = [];
        let currentLevel = 1;
        let targetWordObj = null; // 當前題目物件
        let userInput = ""; // 玩家輸入的字串
        
        // 鍵盤佈局資料
        const keys = [
            "QWERTYUIOP",
            "ASDFGHJKL",
            "ZXCVBNM"
        ];

        // --- 1. 初始化與讀取 JSON ---
        window.onload = async function() {
            renderKeyboard(); // 先畫出灰色的鍵盤
            
            try {
                // 讀取同目錄下的 json
                const response = await fetch('5kVoc.json');
                if (!response.ok) throw new Error("JSON load failed");
                vocabList = await response.json();
                console.log("Vocab loaded:", vocabList.length, "words");
            } catch (e) {
                alert("無法讀取 5kVoc.json，請確認檔案是否存在！(如果是在電腦上直接打開 html，可能會因為瀏覽器安全性擋住，請使用 local server 或上傳到網路)");
                // 這裡放一個假資料當備案，避免完全壞掉
                vocabList = [{"Vocabulary":"test","PoS":"n.","Level":"1","Translation":"測試(資料讀取失敗)"}];
            }

            // 綁定點擊事件：點擊上半部任何地方都會聚焦輸入框
            document.querySelector('.game-container').addEventListener('click', (e) => {
                // 如果點擊的不是按鈕，就聚焦輸入框
                if(e.target.tagName !== 'BUTTON' && targetWordObj) {
                    document.getElementById('hidden-input').focus();
                }
            });

            // 監聽輸入
            document.getElementById('hidden-input').addEventListener('input', handleTyping);
        };

        // --- 2. 介面渲染函式 ---

        function renderKeyboard() {
            const kbContainer = document.getElementById('keyboard-display');
            kbContainer.innerHTML = '';
            keys.forEach(rowStr => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'kb-row';
                for(let char of rowStr) {
                    const keyDiv = document.createElement('div');
                    keyDiv.className = 'kb-key';
                    keyDiv.id = 'key-' + char; // 用 ID 來找它變色
                    keyDiv.innerText = char;
                    rowDiv.appendChild(keyDiv);
                }
                kbContainer.appendChild(rowDiv);
            });
        }

        function selectLevel(lvl) {
            currentLevel = lvl;
            document.querySelectorAll('.lvl-btn').forEach((btn, idx) => {
                if((idx + 1) === lvl) btn.classList.add('selected');
                else btn.classList.remove('selected');
            });
        }

        // --- 3. 遊戲核心流程 ---

        function startGame() {
            // 篩選難度
            const pool = vocabList.filter(v => v.Level == currentLevel);
            
            if (pool.length === 0) {
                alert(`Level ${currentLevel} 沒有找到單字！`);
                return;
            }

            // 隨機選字
            targetWordObj = pool[Math.floor(Math.random() * pool.length)];
            const targetWord = targetWordObj.Vocabulary; // 這是答案單字

            // 重置遊戲狀態
            userInput = "";
            document.getElementById('hidden-input').value = "";
            renderKeyboard(); // 重置鍵盤顏色
            
            // 更新 Hint
            const hintHTML = `Hint | <span class="hint-val">PoS: ${targetWordObj.PoS}</span> / <span class="hint-val">ZH: ${targetWordObj.Translation}</span>`;
            document.getElementById('hint-display').innerHTML = hintHTML;

            // 建立空格
            const board = document.getElementById('answer-board');
            board.innerHTML = '';
            for(let i=0; i<targetWord.length; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot';
                slot.innerText = "?";
                board.appendChild(slot);
            }

            // 自動叫出鍵盤
            document.getElementById('hidden-input').focus();
        }

        function handleTyping(e) {
            if (!targetWordObj) return;

            // 處理輸入文字 (只留英文，轉小寫)
            let val = e.target.value.replace(/[^a-zA-Z]/g, '').toLowerCase();
            const maxLen = targetWordObj.Vocabulary.length;
            
            // 限制長度
            if (val.length > maxLen) val = val.slice(0, maxLen);
            
            e.target.value = val; // 寫回 input 避免髒字元
            userInput = val;

            updateBoard();
        }

        // --- 4. 判斷邏輯 (顏色 + 白色虛線) ---
        function updateBoard() {
            const target = targetWordObj.Vocabulary.toLowerCase();
            const slots = document.querySelectorAll('.slot');
            
            // 計算答案中每個字母的總數 (用於判斷是否畫白色虛線)
            // 例如 "banana" -> {b:1, a:3, n:2}
            const targetCharCounts = {};
            for(let c of target) targetCharCounts[c] = (targetCharCounts[c] || 0) + 1;

            for (let i = 0; i < target.length; i++) {
                const slot = slots[i];
                const letter = userInput[i]; // 玩家輸入的字母 (可能 undefined)

                // 重置基本樣式
                slot.className = 'slot';
                slot.innerText = letter ? letter.toUpperCase() : "?";

                if (!letter) continue; // 還沒輸入這格

                // --- 顏色判斷 ---
                let colorClass = 'red'; // 預設紅色 (錯誤)
                
                if (letter === target[i]) {
                    colorClass = 'blue'; // 位置正確
                } else if (target.includes(letter)) {
                    colorClass = 'yellow'; // 存在但位置錯
                }

                // 套用顏色
                slot.classList.add(colorClass);

                // --- 鍵盤同步變色 ---
                updateKeyboardColor(letter.toUpperCase(), colorClass);

                // --- 白色虛線 (Multi-occur) 判斷 ---
                // 條件：如果這個字母在答案中出現超過 1 次，並且當前狀態是「對的(藍)」或「有的(黃)」
                if (targetCharCounts[letter] > 1 && (colorClass === 'blue' || colorClass === 'yellow')) {
                    slot.classList.add('multi-occur');
                }
            }
        }

        function updateKeyboardColor(char, type) {
            const keyEl = document.getElementById('key-' + char);
            if (!keyEl) return;

            // 優先級邏輯：Blue > Yellow > Red
            // 如果已經是 Blue 了，就不要改成 Yellow 或 Red
            if (keyEl.classList.contains('active-blue')) return;

            // 如果是 Yellow，只有 Blue 可以蓋過它
            if (keyEl.classList.contains('active-yellow') && type !== 'blue') return;

            // 清除舊色
            keyEl.classList.remove('active-blue', 'active-yellow', 'active-red');
            // 上新色
            keyEl.classList.add('active-' + type);
        }

    </script>
</body>
</html>
